// Generated by Haxe 4.3.3
(function ($global) { "use strict";
var $estr = function() { return js_Boot.__string_rec(this,''); },$hxEnums = $hxEnums || {};
var BlenderLoaderPlugin = function() {
	this.blenderExePath = null;
	this.extensions = ["blend"];
	this.properties = [{ type : "info", label : "This plugin automatically run Blender to convert *.blend in your library into *.gltf." + " Ensure you have <a href='http://blender.org/'>Blender</a> installed."},{ type : "file", name : "blenderPath", label : "Path to the blender.exe", description : "Select path to the blender.exe", defaultValue : "", fileFilters : [{ description : "Executable files (*.exe)", extensions : ["exe"]}]}];
	this.menuItemIcon = "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAACXBIWXMAADXTAAA10wEMIUN3AAAC20lEQVQoz23JTWxUVRgG4Pd859x756+97dBOW+jUpEwqUAEppAiTNKRqJ2BMGg1hgSwIEHeGjRsNkjTRBXFhJDEpGoNuFDYNYMRosDTWmIJRws+Ean/uUAhT2qnTdjq3M/fM+Vy589k+gojwf5gFmGsCAEtJEgzDAP/3Kp1OAwBIQAohBAlIX1Nlu1scPLE//vXlqbqjo9nCtagNRUTGGDYAILu7u2HbDjQ5bIQyRkhDUmFV2zPtoVLnqQPt55pbN8lsvnqDiBCNONKybFbGMMAa+xLVYy3xWAoyrEnZFDCVn2i+M5Vfm3lze+OZDrd9z6c3nh6bL5YLUZukeDVzEGH48aFdj/7uaNsQ9znEVsQVbnIbIG0ETpxr66UaLXvqWdGf+3hs9Y1sPvhdZDIZMACX/GQ10OvJcGnv232Jzzd1bm2N9RwJKhteUOsaIi4Kujp+Xi3msksf3BT9siu1mSCIFipOcWdTZeCdV9outsXrmyM7BnmuqV9+dv2BuDQxh+mySy/t7tFq/KNoTBeeowpbpqa1OtmZu/BhenmkMci7FX+V7dat4vtf7+G7W1P44c8choav4nGtSYn6jXienvSphPxny8lU7quXU9Q7PIHhlnAheXAPHSovPDLtLV3014yHNT/A4f4X0UBl6JU8QhFLInu6bnHlTJTfPRAbAhROp0Nn+XyK8+d2VOfvj/LPdzz+5uYD9rxZLlw8ovV74OvH638RnxzvOXvXW7r75ag3AqDBdbBt7FR4ZGdzJbEcRGuys09YERdV7zeuW5uVRdmgM1+UBmWlbe/YH7PFh8tLi1FJ1OJrjvw0ZR7v6oj1diUQtlbuQy7dE44MKFdurL717er7415wTbz+2iH1bGGBJ27dFgBcIbCRGQ0WYUvfZqe/tyOUtBSZ7Hww++PD8pWVdXObBMpiYGAASilMT09jcnJSAnBIIAbAMgwJwAKgAZSEQCAYNSsU8v8FJek74SxGiM4AAAAASUVORK5CYII=)";
	this.menuItemName = "Blender";
	this.priority = 700;
	this.name = "BlenderLoader";
};
BlenderLoaderPlugin.__name__ = true;
BlenderLoaderPlugin.main = function() {
	nanofl.ide.plugins.LoaderPlugins.register(new BlenderLoaderPlugin());
};
BlenderLoaderPlugin.log = function(v,infos) {
};
BlenderLoaderPlugin.prototype = {
	load: function(api,_params,baseDir,files) {
		var _gthis = this;
		this.api = api;
		var params = _params;
		var blendFiles = Lambda.filter(files,function(file) {
			if(file != null) {
				return haxe_io_Path.extension(file.relativePath).toLowerCase() == "blend";
			} else {
				return false;
			}
		});
		if(blendFiles.length == 0 || !this.detectBlenderPath(params)) {
			return Promise.resolve([]);
		}
		var result = new Array(blendFiles.length);
		var _g = 0;
		var _g1 = blendFiles.length;
		while(_g < _g1) {
			var i = _g++;
			result[i] = _gthis.loadFile(baseDir,blendFiles[i],files);
		}
		return Promise.all(result).then(function(_) {
			return [];
		});
	}
	,loadFile: function(baseDir,file,files) {
		var namePath = haxe_io_Path.withoutExtension(file.relativePath);
		var relDestFilePath = namePath + ".gltf";
		var blendFilePath = baseDir + "/" + file.relativePath;
		var destFilePath = baseDir + "/" + relDestFilePath;
		if(!this.api.fileSystem.exists(destFilePath) || this.api.fileSystem.getLastModified(destFilePath).getTime() < this.api.fileSystem.getLastModified(blendFilePath).getTime()) {
			var script = "import bpy; bpy.ops.export_scene.gltf(filepath='" + destFilePath + "', export_format='GLTF_EMBEDDED')";
			var result = this.api.processManager.runCaptured(this.blenderExePath,["-b",blendFilePath,"--python-expr",script]);
			if(result.code == 0 && this.api.fileSystem.exists(destFilePath)) {
				var value = new nanofl.ide.filesystem.CachedFile(baseDir,relDestFilePath);
				files.h[relDestFilePath] = value;
			} else {
				nanofl.engine.Debug.console.error("Error [" + result.code + "] while conversion '" + file.relativePath + "' to '" + relDestFilePath + "':\n" + StringTools.replace(result.out,"\r\n","\n") + StringTools.replace(result.err,"\r\n","\n"));
			}
		}
		var key = file.relativePath;
		if(Object.prototype.hasOwnProperty.call(files.h,key)) {
			delete(files.h[key]);
		}
		return Promise.resolve(null);
	}
	,detectBlenderPath: function(params) {
		if(this.blenderExePath == null) {
			this.blenderExePath = blenderloader_BlenderDetector.detectExePath(this.api.fileSystem,this.api.environment,params);
			if(this.blenderExePath == null) {
				nanofl.engine.Debug.console.error("Blender is not found. Ensure Blender installed and check the path to the blender.exe in Preferences.");
				return false;
			}
		}
		return true;
	}
};
var HxOverrides = function() { };
HxOverrides.__name__ = true;
HxOverrides.substr = function(s,pos,len) {
	if(len == null) {
		len = s.length;
	} else if(len < 0) {
		if(pos == 0) {
			len = s.length + len;
		} else {
			return "";
		}
	}
	return s.substr(pos,len);
};
HxOverrides.now = function() {
	return Date.now();
};
var Lambda = function() { };
Lambda.__name__ = true;
Lambda.filter = function(it,f) {
	var _g = [];
	var x = $getIterator(it);
	while(x.hasNext()) {
		var x1 = x.next();
		if(f(x1)) {
			_g.push(x1);
		}
	}
	return _g;
};
Math.__name__ = true;
var StringTools = function() { };
StringTools.__name__ = true;
StringTools.replace = function(s,sub,by) {
	return s.split(sub).join(by);
};
var blenderloader_BlenderDetector = function() { };
blenderloader_BlenderDetector.__name__ = true;
blenderloader_BlenderDetector.detectExePath = function(fileSystem,env,params) {
	var path = params.blenderPath;
	if(path == null || path == "") {
		path = blenderloader_BlenderDetector.detectExePathInner(fileSystem,env);
		if(path != null) {
			params.blenderPath = path;
		}
	}
	if(!blenderloader_BlenderDetector.isBlenderPathCorrect(fileSystem,params.blenderPath)) {
		return null;
	}
	return params.blenderPath;
};
blenderloader_BlenderDetector.isBlenderPathCorrect = function(fileSystem,compilerPath) {
	if(compilerPath != null && compilerPath != "") {
		return fileSystem.exists(compilerPath);
	} else {
		return false;
	}
};
blenderloader_BlenderDetector.detectExePathInner = function(fileSystem,env) {
	var pfEnvVarName = "PROGRAMW6432";
	var pf = env.get(pfEnvVarName);
	if(pf != null && pf != "") {
		var dir = "Blender Foundation\\Blender";
		var r = pf + "\\" + dir + "\\blender.exe";
		if(fileSystem.exists(r)) {
			return r;
		}
		var dir = "Blender";
		var r = pf + "\\" + dir + "\\blender.exe";
		if(fileSystem.exists(r)) {
			return r;
		}
	}
	var pfEnvVarName = "PROGRAMFILES";
	var pf = env.get(pfEnvVarName);
	if(pf != null && pf != "") {
		var dir = "Blender Foundation\\Blender";
		var r = pf + "\\" + dir + "\\blender.exe";
		if(fileSystem.exists(r)) {
			return r;
		}
		var dir = "Blender";
		var r = pf + "\\" + dir + "\\blender.exe";
		if(fileSystem.exists(r)) {
			return r;
		}
	}
	var pfEnvVarName = "PROGRAMFILES(X86)";
	var pf = env.get(pfEnvVarName);
	if(pf != null && pf != "") {
		var dir = "Blender Foundation\\Blender";
		var r = pf + "\\" + dir + "\\blender.exe";
		if(fileSystem.exists(r)) {
			return r;
		}
		var dir = "Blender";
		var r = pf + "\\" + dir + "\\blender.exe";
		if(fileSystem.exists(r)) {
			return r;
		}
	}
	return null;
};
var haxe_ds_StringMap = function() {
	this.h = Object.create(null);
};
haxe_ds_StringMap.__name__ = true;
haxe_ds_StringMap.prototype = {
	iterator: function() {
		return new haxe_ds__$StringMap_StringMapValueIterator(this.h);
	}
};
var haxe_ds__$StringMap_StringMapValueIterator = function(h) {
	this.h = h;
	this.keys = Object.keys(h);
	this.length = this.keys.length;
	this.current = 0;
};
haxe_ds__$StringMap_StringMapValueIterator.__name__ = true;
haxe_ds__$StringMap_StringMapValueIterator.prototype = {
	hasNext: function() {
		return this.current < this.length;
	}
	,next: function() {
		return this.h[this.keys[this.current++]];
	}
};
var haxe_io_Bytes = function() { };
haxe_io_Bytes.__name__ = true;
var haxe_io_Path = function(path) {
	switch(path) {
	case ".":case "..":
		this.dir = path;
		this.file = "";
		return;
	}
	var c1 = path.lastIndexOf("/");
	var c2 = path.lastIndexOf("\\");
	if(c1 < c2) {
		this.dir = HxOverrides.substr(path,0,c2);
		path = HxOverrides.substr(path,c2 + 1,null);
		this.backslash = true;
	} else if(c2 < c1) {
		this.dir = HxOverrides.substr(path,0,c1);
		path = HxOverrides.substr(path,c1 + 1,null);
	} else {
		this.dir = null;
	}
	var cp = path.lastIndexOf(".");
	if(cp != -1) {
		this.ext = HxOverrides.substr(path,cp + 1,null);
		this.file = HxOverrides.substr(path,0,cp);
	} else {
		this.ext = null;
		this.file = path;
	}
};
haxe_io_Path.__name__ = true;
haxe_io_Path.withoutExtension = function(path) {
	var s = new haxe_io_Path(path);
	s.ext = null;
	return s.toString();
};
haxe_io_Path.extension = function(path) {
	var s = new haxe_io_Path(path);
	if(s.ext == null) {
		return "";
	}
	return s.ext;
};
haxe_io_Path.prototype = {
	toString: function() {
		return (this.dir == null ? "" : this.dir + (this.backslash ? "\\" : "/")) + this.file + (this.ext == null ? "" : "." + this.ext);
	}
};
var haxe_iterators_ArrayIterator = function(array) {
	this.current = 0;
	this.array = array;
};
haxe_iterators_ArrayIterator.__name__ = true;
haxe_iterators_ArrayIterator.prototype = {
	hasNext: function() {
		return this.current < this.array.length;
	}
	,next: function() {
		return this.array[this.current++];
	}
};
var js_Boot = function() { };
js_Boot.__name__ = true;
js_Boot.__string_rec = function(o,s) {
	if(o == null) {
		return "null";
	}
	if(s.length >= 5) {
		return "<...>";
	}
	var t = typeof(o);
	if(t == "function" && (o.__name__ || o.__ename__)) {
		t = "object";
	}
	switch(t) {
	case "function":
		return "<function>";
	case "object":
		if(o.__enum__) {
			var e = $hxEnums[o.__enum__];
			var con = e.__constructs__[o._hx_index];
			var n = con._hx_name;
			if(con.__params__) {
				s = s + "\t";
				return n + "(" + ((function($this) {
					var $r;
					var _g = [];
					{
						var _g1 = 0;
						var _g2 = con.__params__;
						while(true) {
							if(!(_g1 < _g2.length)) {
								break;
							}
							var p = _g2[_g1];
							_g1 = _g1 + 1;
							_g.push(js_Boot.__string_rec(o[p],s));
						}
					}
					$r = _g;
					return $r;
				}(this))).join(",") + ")";
			} else {
				return n;
			}
		}
		if(((o) instanceof Array)) {
			var str = "[";
			s += "\t";
			var _g = 0;
			var _g1 = o.length;
			while(_g < _g1) {
				var i = _g++;
				str += (i > 0 ? "," : "") + js_Boot.__string_rec(o[i],s);
			}
			str += "]";
			return str;
		}
		var tostr;
		try {
			tostr = o.toString;
		} catch( _g ) {
			return "???";
		}
		if(tostr != null && tostr != Object.toString && typeof(tostr) == "function") {
			var s2 = o.toString();
			if(s2 != "[object Object]") {
				return s2;
			}
		}
		var str = "{\n";
		s += "\t";
		var hasp = o.hasOwnProperty != null;
		var k = null;
		for( k in o ) {
		if(hasp && !o.hasOwnProperty(k)) {
			continue;
		}
		if(k == "prototype" || k == "__class__" || k == "__super__" || k == "__interfaces__" || k == "__properties__") {
			continue;
		}
		if(str.length != 2) {
			str += ", \n";
		}
		str += s + k + " : " + js_Boot.__string_rec(o[k],s);
		}
		s = s.substring(1);
		str += "\n" + s + "}";
		return str;
	case "string":
		return o;
	default:
		return String(o);
	}
};
function $getIterator(o) { if( o instanceof Array ) return new haxe_iterators_ArrayIterator(o); else return o.iterator(); }
if(typeof(performance) != "undefined" ? typeof(performance.now) == "function" : false) {
	HxOverrides.now = performance.now.bind(performance);
}
String.__name__ = true;
Array.__name__ = true;
Date.__name__ = "Date";
js_Boot.__toStr = ({ }).toString;
BlenderLoaderPlugin.main();
})({});
